<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PH Observability Chatbot</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
      }

      .chat-container {
        max-width: 700px;
        margin: 50px auto;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        background-color: #fff;
        overflow: hidden;
      }

      .chat-header {
        background-color: #0066cc;
        color: white;
        padding: 15px 20px;
        font-size: 1.3em;
        font-weight: 500;
      }

      .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background-color: #f9f9f9;
      }

      .message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 10px;
      }

      .user-message {
        background-color: #e6f2ff;
        margin-left: auto;
        border-bottom-right-radius: 0;
      }

      .bot-message {
        background-color: #f0f0f0;
        border-bottom-left-radius: 0;
      }

      .chat-input {
        padding: 15px;
        background-color: #fff;
        border-top: 1px solid #eee;
      }

      .chat-input form {
        display: flex;
      }

      .chat-input input {
        flex-grow: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px 15px;
      }

      .chat-input button {
        margin-left: 10px;
      }

      .status-bar {
        padding: 5px 15px;
        background-color: #f0f0f0;
        font-size: 0.8em;
        color: #666;
        text-align: right;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #0066cc;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-container">
        <div class="chat-header">PH Observability Chatbot</div>
        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            Hello! I'm your retail assistant. How can I help you today?
          </div>
        </div>
        <div class="status-bar">
          <span id="statusText">Connected</span>
          <span
            id="loadingIndicator"
            class="loading"
            style="display: none"
          ></span>
        </div>
        <div class="chat-input">
          <form id="chatForm">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message..."
              autocomplete="off"
            />
            <button type="submit" class="btn btn-primary">Send</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // DOM elements
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const statusText = document.getElementById("statusText");
      const loadingIndicator = document.getElementById("loadingIndicator");

      // Conversation state
      let conversationId = null;

      // Handle form submission
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        // Clear input
        messageInput.value = "";

        // Add user message to UI
        addMessage(message, "user");

        // Show loading state
        statusText.textContent = "Thinking...";
        loadingIndicator.style.display = "inline-block";

        try {
          // Send message to API
          const response = await sendMessage(message);

          // Add bot response to UI
          addMessage(response.response, "bot");

          // Update conversation ID for future messages
          conversationId = response.conversationId;

          // Update status
          statusText.textContent = "Connected";
        } catch (error) {
          console.error("Error sending message:", error);

          // Show error in UI
          addMessage("Sorry, I encountered an error. Please try again.", "bot");

          // Update status
          statusText.textContent = "Error occurred";
        } finally {
          // Hide loading indicator
          loadingIndicator.style.display = "none";
        }
      });

      // Add a message to the chat UI
      function addMessage(text, sender) {
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");
        messageElement.classList.add(
          sender === "user" ? "user-message" : "bot-message"
        );
        messageElement.textContent = text;

        chatMessages.appendChild(messageElement);

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Send message to the API
      async function sendMessage(message) {
        // In a real application, you would retrieve and use a JWT token for authentication
        // For demo purposes, we're sending without authentication
        const payload = {
          message,
          ...(conversationId && { conversationId }),
        };

        const response = await fetch("/api/chatbot/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            // In a real application: 'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        return await response.json();
      }
    </script>
  </body>
</html>
